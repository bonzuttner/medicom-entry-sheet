# PharmaPOP Entry System - 権限テスト手順書

このドキュメントは、[PERMISSIONS.md](PERMISSIONS.md) に記載されている権限設計が正しく実装されているかを確認するためのテスト手順書です。

## テスト環境

### 開発モード（LocalStorage）

```bash
npm run dev
```

http://localhost:3000 にアクセス

### APIモード（Vercel Functions）

```bash
# Vercel CLIにログイン（初回のみ）
vercel login

# APIサーバー起動
npm run dev:api
```

http://localhost:3000 にアクセス

---

## テスト対象ユーザー

| ユーザー名 | パスワード | メーカー | 権限 |
|----------|----------|---------|------|
| **admin** | Password1! | メディコム | ADMIN |
| **satou** | Satou1!! | 大江戸製薬 | STAFF |
| **tanaka** | Tanaka1! | 富士ファーマ | STAFF |

---

## テスト1: ADMIN ユーザー（admin）

### 1.1 ログイン

- [ ] ユーザー名: `admin`、パスワード: `Password1!` でログイン
- [ ] ログイン成功
- [ ] 画面右上に「管理者 (admin)」と表示される

### 1.2 エントリーシート一覧

- [ ] 「エントリーシート一覧」をクリック
- [ ] **全メーカーのシート**が表示される
  - [ ] 大江戸製薬のシート（2件）が表示される
  - [ ] 富士ファーマのシート（1件）が表示される
  - [ ] 合計3件以上のシートが表示される

### 1.3 他社シート操作

- [ ] 大江戸製薬のシートの「編集」ボタンをクリック
- [ ] **編集可能**（ボタンが有効）
- [ ] シート詳細が表示される
- [ ] 「キャンセル」で戻る

- [ ] 大江戸製薬のシートの「削除」ボタンをクリック
- [ ] **削除確認ダイアログ**が表示される
- [ ] 「キャンセル」で中止

### 1.4 アカウント管理

- [ ] 「アカウント管理」をクリック
- [ ] **全アカウント**が表示される
  - [ ] admin（メディコム）
  - [ ] satou（大江戸製薬）
  - [ ] tanaka（富士ファーマ）
  - [ ] 合計3名以上

### 1.5 他社アカウント操作

- [ ] satou（大江戸製薬）の「編集」ボタンをクリック
- [ ] **編集可能**（モーダルが表示される）
- [ ] メーカー名が「大江戸製薬」と表示される
- [ ] 「キャンセル」で閉じる

### 1.6 他社アカウント作成

- [ ] 「新規作成」ボタンをクリック
- [ ] メーカー名を「富士ファーマ」に設定
- [ ] ユーザー名、パスワード、その他を入力
- [ ] **作成可能**（バリデーションエラーなし）
- [ ] 「キャンセル」で中止

### 1.7 マスタ管理

- [ ] 「マスタ管理」メニューが**表示される**
- [ ] 「マスタ管理」をクリック
- [ ] マスタ管理画面が表示される
- [ ] メーカー名、棚割名、リスク分類、特定成分の編集フィールドが表示される
- [ ] **編集可能**

### 1.8 ログアウト

- [ ] 「ログアウト」をクリック
- [ ] ログイン画面に戻る

---

## テスト2: STAFF ユーザー（satou - 大江戸製薬）

### 2.1 ログイン

- [ ] ユーザー名: `satou`、パスワード: `Satou1!!` でログイン
- [ ] ログイン成功
- [ ] 画面右上に「satou (大江戸製薬)」と表示される

### 2.2 エントリーシート一覧

- [ ] 「エントリーシート一覧」をクリック
- [ ] **大江戸製薬のシートのみ**が表示される
  - [ ] 大江戸製薬のシート（2件）が表示される
  - [ ] 富士ファーマのシートは**表示されない**

### 2.3 自社シート操作

- [ ] 大江戸製薬のシートの「編集」ボタンをクリック
- [ ] **編集可能**（ボタンが有効）
- [ ] シート詳細が表示される
- [ ] 「キャンセル」で戻る

- [ ] 大江戸製薬のシートの「削除」ボタンをクリック
- [ ] **削除確認ダイアログ**が表示される
- [ ] 「キャンセル」で中止

### 2.4 他社シート表示

- [ ] エントリーシート一覧で富士ファーマのシートが**表示されない**ことを確認
- [ ] 検索フィルタを使っても他社のシートは**表示されない**

### 2.5 アカウント管理

- [ ] 「アカウント管理」をクリック
- [ ] **大江戸製薬のアカウントのみ**が表示される
  - [ ] satou（大江戸製薬）のみ表示
  - [ ] admin（メディコム）は**表示されない**
  - [ ] tanaka（富士ファーマ）は**表示されない**

### 2.6 自社アカウント操作

- [ ] satou（自分）の「編集」ボタンをクリック
- [ ] **編集可能**（モーダルが表示される）
- [ ] メーカー名が「大江戸製薬」で**固定**（変更不可）
- [ ] 「キャンセル」で閉じる

### 2.7 自社アカウント作成

- [ ] 「新規作成」ボタンをクリック
- [ ] メーカー名が「大江戸製薬」で**自動入力**される
- [ ] メーカー名フィールドが**無効化**（変更不可）
- [ ] ユーザー名、パスワード、その他を入力
- [ ] **作成可能**（バリデーションエラーなし）
- [ ] 「キャンセル」で中止

### 2.8 他社アカウント作成試行

- [ ] 開発者ツールを開く（F12）
- [ ] Consoleタブで以下を実行:
  ```javascript
  // メーカー名を他社に変更しようとする（手動では不可のはず）
  // この操作は通常UIでは不可能
  ```
- [ ] UI上ではメーカー名を他社に変更できないことを確認

### 2.9 マスタ管理

- [ ] 「マスタ管理」メニューが**表示されない**ことを確認
- [ ] URLバーに直接 `http://localhost:3000` を入力してアクセス
- [ ] ページ内で「マスタ管理」コンポーネントが**レンダリングされない**ことを確認

### 2.10 ログアウト

- [ ] 「ログアウト」をクリック
- [ ] ログイン画面に戻る

---

## テスト3: STAFF ユーザー（tanaka - 富士ファーマ）

### 3.1 ログイン

- [ ] ユーザー名: `tanaka`、パスワード: `Tanaka1!` でログイン
- [ ] ログイン成功
- [ ] 画面右上に「tanaka (富士ファーマ)」と表示される

### 3.2 エントリーシート一覧

- [ ] 「エントリーシート一覧」をクリック
- [ ] **富士ファーマのシートのみ**が表示される
  - [ ] 富士ファーマのシート（1件）が表示される
  - [ ] 大江戸製薬のシートは**表示されない**

### 3.3 自社シート操作

- [ ] 富士ファーマのシートの「編集」ボタンをクリック
- [ ] **編集可能**（ボタンが有効）
- [ ] シート詳細が表示される
- [ ] 「キャンセル」で戻る

### 3.4 アカウント管理

- [ ] 「アカウント管理」をクリック
- [ ] **富士ファーマのアカウントのみ**が表示される
  - [ ] tanaka（富士ファーマ）のみ表示
  - [ ] admin（メディコム）は**表示されない**
  - [ ] satou（大江戸製薬）は**表示されない**

### 3.5 自社アカウント作成

- [ ] 「新規作成」ボタンをクリック
- [ ] メーカー名が「富士ファーマ」で**自動入力**される
- [ ] メーカー名フィールドが**無効化**（変更不可）
- [ ] ユーザー名、パスワード、その他を入力
- [ ] **作成可能**（バリデーションエラーなし）
- [ ] 「キャンセル」で中止

### 3.6 ログアウト

- [ ] 「ログアウト」をクリック
- [ ] ログイン画面に戻る

---

## テストサマリー

### 期待される結果

| テスト項目 | ADMIN | STAFF (satou) | STAFF (tanaka) |
|-----------|-------|---------------|---------------|
| ログイン成功 | ✅ | ✅ | ✅ |
| 全メーカーのシート閲覧 | ✅ | ❌ (自社のみ) | ❌ (自社のみ) |
| 他社シート編集 | ✅ | ❌ | ❌ |
| 他社シート削除 | ✅ | ❌ | ❌ |
| 全アカウント閲覧 | ✅ | ❌ (自社のみ) | ❌ (自社のみ) |
| 他社アカウント編集 | ✅ | ❌ | ❌ |
| 他社アカウント作成 | ✅ | ❌ | ❌ |
| 自社アカウント作成 | ✅ | ✅ | ✅ |
| マスタ管理メニュー表示 | ✅ | ❌ | ❌ |
| マスタ管理画面アクセス | ✅ | ❌ | ❌ |

### チェックリスト

テスト完了後、以下を確認してください:

- [ ] すべての ADMIN 機能が正常に動作した
- [ ] STAFF ユーザーは自社データのみにアクセスできた
- [ ] STAFF ユーザーは他社データにアクセスできなかった
- [ ] STAFF ユーザーはマスタ管理にアクセスできなかった
- [ ] 権限エラー時に適切なメッセージが表示された

---

## トラブルシューティング

### ログインできない

- パスワードが正しいか確認（大文字小文字を区別）
- 開発者ツールのConsoleでエラーを確認
- LocalStorageをクリアして再試行: `localStorage.clear()`

### シートやアカウントが表示されない

- 初期データが正しく読み込まれているか確認
- Consoleで以下を実行:
  ```javascript
  console.log(JSON.parse(localStorage.getItem('pharmapop_sheets')));
  console.log(JSON.parse(localStorage.getItem('pharmapop_users')));
  ```

### マスタ管理が表示される（STAFFで）

- ログアウトして再ログイン
- ユーザーのロールが正しいか確認:
  ```javascript
  console.log(JSON.parse(localStorage.getItem('pharmapop_current_user')));
  ```

---

## 自動テストスクリプト（APIモード）

APIモードの場合、[test-permissions.sh](../test-permissions.sh) を実行して自動テストができます。

```bash
# Vercel CLIにログイン
vercel login

# APIサーバー起動
npm run dev:api

# 別のターミナルでテスト実行
./test-permissions.sh
```

---

## 参考資料

- [PERMISSIONS.md](PERMISSIONS.md) - 権限設計書
- [SECURITY.md](SECURITY.md) - セキュリティ設計書
- [README.md](../README.md) - プロジェクト概要
